<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiveIn - Criaturas</title>
    <link rel="icon" href="../assets/logo.png">
    <link rel="stylesheet" href="../css/criaturas.css">
    <script src="../js/sessao.js"></script>
</head>
<header>
    <div class="menu">
        <div class="opcoesL">
            <img src="../assets/logo.png" alt="Logotipo DiveIn">
        </div>
        <h3 id="saudacao">Olá, </h3>
        <div class="opcoesR">
            <a href="dashboard.html" class="normal">DASHBOARD</a>
            <a href="" onclick="limparSessao()" class="inOut">SAIR</a>
        </div>
    </div>
</header>

<body onload="validarSessao()">
    <div class="container">
        <div class="elementos">
            <h1>CRIATURAS</h1>
            <div class="selecione">
                <p><b>Selecione a criatura</b>:</p><select onchange="selecionar()" class="criatura" id="slCriatura">
                    <option value="#">Selecione</option>
                </select>
            </div>
            <div class="dados">
                <div class="imagem" id="imagem">
                    <img src="https://cembra.org.br/sites/default/files/2025-05/fundo-do-oceano.jpg"
                        alt="Selecione uma criatura">
                </div>
                <div class="texto" id="texto">
                    <p><b>Nome:</b></p>
                    <p><b>Nome científico:</b></p>
                    <p><b>Habitat:</b></p>
                    <p><b>Localização:</b></p>
                    <p><b>Descrição:</b></p>
                    <div class="avistados">
                        <h3>Ultimos registros</h3>
                        <p id="ultimosRegistros" class="ultimosRegistros"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    let saudacao = document.getElementById(`saudacao`);
    saudacao.innerHTML += `${sessionStorage.NOME_USUARIO} ${sessionStorage.SOBRENOME_USUARIO}`;
    let proximaAtualizacao;
    var historico = sessionStorage.ID_USUARIO;
    var avistado = '';
    var idCriatura = '';
    var cNome = '';
    window.onload = () => buscarNome(historico);
    function selecionar() {
        if (slCriatura.value == '#') {
            texto.innerHTML = `<p><b>Nome:</b></p>
                    <p><b>Nome científico:</b></p>
                    <p><b>Habitat:</b></p>
                    <p><b>Localização:</b></p>
                    <p><b>Vezes que foi avistada no ultimo mês:</b></p>
                    <p><b>Descrição:</b></p>`;
        } else {
            idCriatura = slCriatura.value;
            buscarRegistro(historico);
        }
    }
    function buscarNome(historico) {
        fetch(`/medidas/lista-criatura/${historico}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (lista) {
                    console.log(`Dados recebidos: ${JSON.stringify(lista)}`);
                    for (let i = 0; i < lista.length; i++) {
                        let nomeCriatura = lista[i];
                        slCriatura.innerHTML += `<option value="${nomeCriatura.nome}">${nomeCriatura.nome}</option>`;
                    }
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
    function buscarQuantidade(cNome) {
        console.log(cNome + ' Nome da criatura')
        fetch(`/medidas/quantidade-criatura/${cNome}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (lista) {
                    console.log(lista)
                    console.log(`Dados recebidos: ${JSON.stringify(lista)}`);
                    for (let i = 0; i < lista.length; i++) {
                        let nomeCriatura = lista[i];
                        registrada = nomeCriatura.avistado;
                        mes = nomeCriatura.mes;
                        ano = nomeCriatura.ano;
                        if (registrada == 1) {
                            ultimosRegistros.innerHTML = `Esta criatura foi avistada ${registrada} vez no mes ${mes} de ${ano}`;
                        } else {
                            ultimosRegistros.innerHTML = `Esta criatura foi avistada ${registrada} vezes no mes ${mes} de ${ano}`;
                        }
                    }
                    console.log(avistado + 'oi')
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
    function buscarRegistro(historico) {
        fetch(`/medidas/descricao-criatura/${historico}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (lista) {
                    console.log(`Dados recebidos: ${JSON.stringify(lista)}`);
                    for (let i = 0; i < lista.length; i++) {
                        let nomeCriatura = lista[i];
                        if (nomeCriatura.nome == idCriatura) {
                            cNome = nomeCriatura.id;
                            texto.innerHTML = `<p><b>Nome:</b> ${nomeCriatura.nome}</p>
                            <p><b>Nome científico:</b> ${nomeCriatura.nomeCientifico}</p>
                            <p><b>Habitat:</b> ${nomeCriatura.habitat}</p>
                            <p><b>Localização:</b> ${nomeCriatura.praia} - ${nomeCriatura.uf}</p>
                            <p><b>Descrição:</b> ${nomeCriatura.descricao}</p>
                            <div class="avistados">
                                <h3>Ultimos registros</h3>
                                <p id="ultimosRegistros" class="ultimosRegistros"></p>
                            </div>`;
                            imagem.innerHTML = `<img src="${nomeCriatura.foto}" alt="Foto de ${nomeCriatura.nome}">`;
                            buscarQuantidade(cNome);
                            break;
                        }
                    }
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
</script>

</html>